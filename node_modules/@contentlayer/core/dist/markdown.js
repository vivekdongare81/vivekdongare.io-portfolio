import * as tracing_1 from "@effect-ts/core/Tracing";
const fileName_1 = "packages/@contentlayer/core/src/markdown.ts";
import { errorToString } from '@contentlayer/utils';
import { OT, pipe, T, Tagged } from '@contentlayer/utils/effect';
import rehypeStringify from 'rehype-stringify';
import remarkFrontmatter from 'remark-frontmatter';
import remarkParse from 'remark-parse';
import remark2rehype from 'remark-rehype';
import { unified } from 'unified';
export const markdownToHtml = ({ mdString, options, }) => (OT.withSpan('@contentlayer/core/markdown:markdownToHtml')(T.mapError_(T.catchAllDefect_(T.gen(function* ($) {
    // const matterResult = matter(mdString)
    // Use remark to convert markdown into HTML string
    // const processedContent = await remark().use(html).process(matterResult.content)
    if (process.env['CL_FAST_MARKDOWN']) {
        // NOTE `markdown-wasm` is an optional peer dependency
        return yield* $(T.tryPromise(async () => {
            const { parse: parseWasm } = await import('markdown-wasm/dist/markdown.node.js');
            return parseWasm(mdString);
        }, fileName_1 + ":29:23"), fileName_1 + ":28:24");
    }
    const builder = unified();
    // parses out the frontmatter (which is needed for full-document parsing)
    builder.use(remarkFrontmatter);
    // parse markdown
    builder.use(remarkParse);
    if (options?.remarkPlugins) {
        builder.use(options.remarkPlugins);
    }
    builder.use(remark2rehype);
    if (options?.rehypePlugins) {
        builder.use(options.rehypePlugins);
    }
    // rehype to html
    builder.use(rehypeStringify);
    const res = yield* $(T.tryPromise(() => builder.process(mdString), fileName_1 + ":57:40"), fileName_1 + ":57:27");
    return res.toString();
}, fileName_1 + ":20:10"), tracing_1.traceCallLast(T.fail, fileName_1 + ":61:28"), fileName_1 + ":61:21"), (error) => new UnexpectedMarkdownError({ error }), fileName_1 + ":62:15")));
export class UnexpectedMarkdownError extends Tagged('UnexpectedMarkdownError') {
    constructor() {
        super(...arguments);
        this.toString = () => `UnexpectedMarkdownError: ${errorToString(this.error)}`;
    }
}
//# sourceMappingURL=markdown.js.map